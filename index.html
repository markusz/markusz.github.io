<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>Works on my machine</title>
  <meta name="author" content="Markus Ziller">
  
  <meta name="description" content="Talking about tech stuff I do">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Works on my machine"/>

  
    <meta property="og:image" content=""/>
  

  <link rel="shortcut icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
  

<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Works on my machine</a></h1>
  <h2><a href="/">console.log(&#39;sdfadgqgadfggaggfsfsfsdthis message should not appear wtf&#39;)</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/null">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article id="post-ccminer-ubuntu" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2017-05-14T14:37:11.000Z"><a href="/2017/05/14/ccminer-ubuntu/">14.05.2017</a></time>
      
      
  
    <h1 class="title"><a href="/2017/05/14/ccminer-ubuntu/">Simplified GPU-powered cryptocurrency mining on Ubuntu 16.04</a></h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <p>I recently won $12k in Microsoft Azure credits at a Hackathon, which I didn’t have any real use for. Since I didn’t want them to expire either, I decided to at last mine some cryptocurrency on Azure’s GPU-powered VMs of the NV-series.<br>Getting everything set up on Ubuntu 16.04 proved to be a very manual and tedious process, especially when spinning up several VMs.</p>
<p>To that end, I created <a target="_blank" rel="noopener" href="https://github.com/markusz/gpu-mining-on-ubuntu16">some scripts</a> that make installing the required miners incl. all dependencies, libs and frameworks a lot easier.<br>In the <code>/steps</code> folder of the repo, you will find a few scripts that - when executed in the given order with <strong>root permissions</strong> - will setup everything you need to start mining with ccminer</p>
<h2 id="1-Prepare-packages"><a href="#1-Prepare-packages" class="headerlink" title="1. Prepare packages"></a>1. Prepare packages</h2><p>We create a subfolder <code>~/mining</code> in the users home directory, where we will install everything we’re going to need. We also have to install a number of packages later steps depend on.</p>
<figure class="highlight bash"><figcaption><span>1_aptget.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/mining</span><br><span class="line">apt-get update &amp;&amp; apt-get -y dist-upgrade</span><br><span class="line">apt-get install gcc g++ build-essential libssl-dev automake linux-headers-$(<span class="built_in">uname</span> -r) git gawk libcurl4-openssl-dev libjansson-dev xorg libc++-dev libgmp-dev python-dev</span><br></pre></td></tr></table></figure>

<h2 id="2-Download-Nvidia-Driver-and-CUDA"><a href="#2-Download-Nvidia-Driver-and-CUDA" class="headerlink" title="2. Download Nvidia Driver and CUDA"></a>2. Download Nvidia Driver and CUDA</h2><p>At the time of writing this, versions 375.66 of the Nvidia driver and 8.0 of CUDA were the most recent - change accordingly, if newer versions are available.</p>
<figure class="highlight bash"><figcaption><span>2_getinstaller.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/mining &amp;&amp; wget http://us.download.nvidia.com/XFree86/Linux-x86_64/375.66/NVIDIA-Linux-x86_64-375.66.run</span><br><span class="line"><span class="built_in">chmod</span> +x ~/mining/NVIDIA-Linux-x86_64-375.66.run</span><br><span class="line"><span class="built_in">cd</span> ~/mining &amp;&amp; wget https://developer.nvidia.com/compute/cuda/8.0/prod/local_installers/cuda-repo-ubuntu1604-8-0-local_8.0.44-1_amd64-deb</span><br></pre></td></tr></table></figure>


<h2 id="3a-Disable-Nouveau-driver"><a href="#3a-Disable-Nouveau-driver" class="headerlink" title="3a. Disable Nouveau driver"></a>3a. Disable Nouveau driver</h2><p>In order to use the Nvidia Driver, we first will have to disable the default <code>Noveau</code> driver. The installation of the Nvidia driver will fail on the first run, but will also disable the Noveau driver, so that after rebooting the machine, the installation will work.</p>
<figure class="highlight bash"><figcaption><span>3a_install-nvidia-driver.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/mining/NVIDIA-Linux-x86_64-375.66.run --accept-license --no-questions --disable-nouveau --no-install-compat32-libs</span><br></pre></td></tr></table></figure>

<h2 id="3b-Install-Nvidia-driver"><a href="#3b-Install-Nvidia-driver" class="headerlink" title="3b. Install Nvidia driver"></a>3b. Install Nvidia driver</h2><p><code>Noveau</code> driver has been disabled by the previous run of the Nvidia Installer. This will now work</p>
<figure class="highlight bash"><figcaption><span>3b_install-nvidia-driver.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/mining/NVIDIA-Linux-x86_64-375.66.run --accept-license --no-questions --disable-nouveau --no-install-compat32-libs</span><br></pre></td></tr></table></figure>

<h2 id="4-Install-CUDA"><a href="#4-Install-CUDA" class="headerlink" title="4. Install CUDA"></a>4. Install CUDA</h2><p>Cryptocurrencies are obtained by using computing power to calculate for a large number of input variables (hashes) if they match certain criteria.<br>The possibility of finding a match is often referred to as the difficulty of the currency, i.e. at the time of writing Bitcoin’s difficulty was 595,921,917,085, meaning that only one out of 600 Billion checks would result in an actual positive result, aka a Bitcoin.<br>It is obvious that doing more calculations in parallel is favourable to the yield of the mining. </p>
<p>That’s where GPUs come in - they have significantly more computing units, thus allowing a much higher rate of parallelism at checking hashes.<br>CUDA is a technology developed by Nvidia that enables using GPUs to process general purpose calculations (such as checking hashes). </p>
<p>This speeds up calculations significantly, simply due to the total number of cores available (4096 cores in an Nvidia M60 vs. 4 in a current gen Intel i7)</p>
<figure class="highlight bash"><figcaption><span>4_install-cuda.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dpkg -i ~/mining/cuda-repo-ubuntu1604-8-0-local_8.0.44-1_amd64-deb</span><br><span class="line"></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install cuda-toolkit-8-0</span><br><span class="line">usermod -a -G video $(<span class="built_in">whoami</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export PATH=/usr/local/cuda-8.0/bin:<span class="variable">$PATH</span>&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export LD_LIBRARY_PATH=/usr/local/cuda8.0/lib64:<span class="variable">$LD_LIBRARY_PATH</span>&quot;</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>

<p><code>dkpg</code> might take a while. If shell script hangs or dies, try executing it manually.</p>
<p><strong>Reboot again</strong></p>
<h2 id="5-Install-ccminer"><a href="#5-Install-ccminer" class="headerlink" title="5. Install ccminer"></a>5. Install ccminer</h2><p>After a reboot, we have all the drivers installed and ready. The only thing missing is a mining software that knows how to do the actual calculations that will result in coins.<br>ccminer is one of the most widespread solutions and provides support for a large number of different currencies</p>
<figure class="highlight bash"><figcaption><span>5_make-ccminer.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/cuda/samples/1_Utilities/deviceQuery</span><br><span class="line">make</span><br><span class="line">/usr/local/cuda/samples/1_Utilities/deviceQuery/deviceQuery</span><br><span class="line"><span class="built_in">cd</span> ~/mining</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/tpruvot/ccminer</span><br><span class="line"><span class="built_in">cd</span> ccminer</span><br><span class="line">git checkout linux</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="Other-miners"><a href="#Other-miners" class="headerlink" title="Other miners"></a>Other miners</h3><p>Setting up other miners (i.e. Marlin for Siacoin - see 6_install-marlin.sh)should be fairly easy at this point since most complexity goes into preparing the system to correctly utilize its GPU units.</p>
<p>Happy mining</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article id="post-s3-lambda" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2017-04-20T16:57:49.000Z"><a href="/2017/04/20/s3-lambda/">20.04.2017</a></time>
      
      
  
    <h1 class="title"><a href="/2017/04/20/s3-lambda/">Batch checking contents of an S3 bucket with AWS lambda</a></h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <p>A while ago, I faced the challenge to check the contents of a few thousand folders in an AWS bucket to see if they meet certain criteria, i.e. number and type of files per folder, etc.<br>The best way to achieve this proved to be a node.js script ran on Lambda with an API Gateway in front, for a number of reasons:</p>
<ul>
<li>The aws-sdk is preinstalled for every lambda function and can be required without any installation</li>
<li>Granting Lambda read access to a certain bucket is quite easy</li>
<li>Lambdas can have a number of triggers, i.e. Any AWS event, HTTP requests through API Gateway or a cron like execution</li>
<li>API Gateway makes it easy to provide a simple REST interface for your endpoint or even offer a user-friendly UI (Minimalistic Angular 1 in S3 my case)</li>
<li>Most things can be handled by the serverless framework for you, without the need to fiddle around with AWS</li>
</ul>
<h3 id="The-Script"><a href="#The-Script" class="headerlink" title="The Script"></a>The Script</h3><p>One thing worth mentioning is that AWS limits the number of objects per <code>listObjectsV2</code> call to 1000. If your bucket contains more elements (in my case up to 25.000), your API response will contain a field called <code>NextContinuationToken</code> which allows you to fire another request that continues where the first request got capped.</p>
<p>We use these tokens to recursive call the <code>getObjects</code> call until the list is finished and call <code>handleObjectList</code> on the elements of each call. An object outside the call scope can be used to collect data of each call and keep it for the <code>onFinsihed</code> function to calculate the final result.</p>
<p>In this example we also provide parameters to ignore certain elements when invoking the execution via REST call or set the bucket name dynamically. This is of course optional, but proved to be quite useful for my use case.</p>
<p>Another thing that I found quite useful was to publish the results to an SNS topic for further processing - this is optional as well, but I nonetheless left the code in the snippet.</p>
<p>The actual script is not really rocket science and looks as follows. </p>
<figure class="highlight js"><figcaption><span>bucket_check.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">checkBucket</span> = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">AWS</span> = <span class="built_in">require</span>(<span class="string">&#x27;aws-sdk&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> s3 = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title function_">S3</span>();</span><br><span class="line">  <span class="keyword">const</span> sns = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title function_">SNS</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> requestBody = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(event.<span class="property">body</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// [OPTIONAL] can be used to store results of the iterations</span></span><br><span class="line">  <span class="keyword">const</span> resultJSON = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// [OPTIONAL] provided queryParams to control script, i.e. &amp;ignore=1,2,3 could be used to ignore elements 1,2 and 3</span></span><br><span class="line">  <span class="keyword">const</span> scriptParams = &#123;</span><br><span class="line">    <span class="attr">ignore</span>: requestBody.<span class="property">ignore</span> || []</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(scriptParams);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> s3Params = &#123;</span><br><span class="line">    <span class="title class_">Bucket</span>: requestBody.<span class="property">bucket</span>,</span><br><span class="line">    <span class="title class_">Prefix</span>: <span class="string">&#x27;your/folder/within/the/bucket&#x27;</span> <span class="comment">// limits the results to only a certain folder</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> <span class="title function_">onFinished</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> result = &#123;</span><br><span class="line">      <span class="attr">checkedBucket</span>: s3Params.<span class="property">Bucket</span>,</span><br><span class="line">      <span class="comment">// ..</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SNS is optional, but proved quite useful. If not needed, just call callback(null, response) directly</span></span><br><span class="line">    sns.<span class="title function_">publish</span>(&#123;</span><br><span class="line">      <span class="title class_">TopicArn</span>: <span class="string">&quot;arn:aws:sns:&lt;topic&gt;&quot;</span>,</span><br><span class="line">      <span class="title class_">Message</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(result)</span><br><span class="line">    &#125;, <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(err ? <span class="string">&#x27;error publishing to SNS&#x27;</span> : <span class="string">&#x27;Message published to SNS&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Required if you want to use an AWS API Gateway in front</span></span><br><span class="line">      <span class="keyword">const</span> response = &#123;</span><br><span class="line">        <span class="string">&quot;statusCode&quot;</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="string">&quot;headers&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;Access-Control-Allow-Origin&quot;</span> : <span class="string">&quot;*&quot;</span>, <span class="comment">// Required for CORS support to work</span></span><br><span class="line">          <span class="string">&quot;Access-Control-Allow-Credentials&quot;</span> : <span class="literal">true</span> <span class="comment">// Required for cookies, authorization headers with HTTPS</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;body&quot;</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(result)</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="title function_">callback</span>(<span class="literal">null</span>, response);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> <span class="title function_">handleObjectList</span> = (<span class="params">data</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// Keys of the form &quot;a/b/c.jpg&quot;</span></span><br><span class="line">    <span class="keyword">const</span> keys = data.<span class="property">Contents</span>.<span class="title function_">map</span>(<span class="function"><span class="params">c</span> =&gt;</span> c.<span class="property">Key</span>);</span><br><span class="line"></span><br><span class="line">    keys.<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// do something with the filename, i.e. aggregate the data in resultJSON</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">getObjects</span> = (<span class="params">token</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (token) &#123;</span><br><span class="line">      s3Params.<span class="property">ContinuationToken</span> = token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s3.<span class="title function_">listObjectsV2</span>(s3Params, <span class="function">(<span class="params">err, objectsResponse</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(err, err.<span class="property">stack</span>); <span class="comment">// an error occurred</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">handleObjectList</span>(objectsResponse);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (objectsResponse.<span class="property">NextContinuationToken</span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Continuing Request with Token &#x27;</span>, objectsResponse.<span class="property">NextContinuationToken</span>);</span><br><span class="line">          <span class="comment">// Recursive call with the ContinuationToken of the previous request</span></span><br><span class="line">          <span class="title function_">getObjects</span>(objectsResponse.<span class="property">NextContinuationToken</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">onFinished</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getObjects</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Deploy"><a href="#Deploy" class="headerlink" title="Deploy"></a>Deploy</h3><p>The easiest way of putting this to work is by getting everything set up by the <a target="_blank" rel="noopener" href="https://serverless.com/">Serverless framework</a>. In this example, it will</p>
<ul>
<li>Zip, upload and deploy your code into an Lambda function</li>
<li>Create an API Gateway as an entry point</li>
<li>Wire everything together and set the correct permissions and roles</li>
</ul>
<figure class="highlight yaml"><figcaption><span>serverless.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">service:</span> <span class="string">bucket-checker</span></span><br><span class="line"></span><br><span class="line"><span class="attr">provider:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">aws</span></span><br><span class="line">  <span class="attr">runtime:</span> <span class="string">nodejs6.10</span></span><br><span class="line">  <span class="attr">region:</span> <span class="string">eu-central-1</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">stage</span></span><br><span class="line">  <span class="attr">profile:</span> <span class="string">bucket-check</span></span><br><span class="line">  <span class="attr">memorySize:</span> <span class="number">1536</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">180</span></span><br><span class="line">  <span class="attr">iamRoleStatements:</span></span><br><span class="line">        <span class="bullet">-</span>  <span class="attr">Effect:</span> <span class="string">&quot;Allow&quot;</span></span><br><span class="line">           <span class="attr">Action:</span></span><br><span class="line">             <span class="bullet">-</span> <span class="string">&quot;s3:Get*&quot;</span></span><br><span class="line">             <span class="bullet">-</span> <span class="string">&quot;s3:List*&quot;</span></span><br><span class="line">           <span class="attr">Resource:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">        <span class="bullet">-</span>  <span class="attr">Effect:</span> <span class="string">&quot;Allow&quot;</span></span><br><span class="line">           <span class="attr">Action:</span></span><br><span class="line">             <span class="bullet">-</span> <span class="string">&quot;sns:*&quot;</span></span><br><span class="line">           <span class="attr">Resource:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="attr">checkBucket:</span></span><br><span class="line">    <span class="attr">handler:</span> <span class="string">bucket_checker.checkBucket</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">$&#123;self:provider.stage&#125;-checkBucket</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Checks</span> <span class="string">the</span> <span class="string">contents</span> <span class="string">of</span> <span class="string">a</span> <span class="string">given</span> <span class="string">S3</span> <span class="string">Bucket</span></span><br><span class="line">    <span class="attr">events:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">bucket/validate</span></span><br><span class="line">          <span class="attr">method:</span> <span class="string">post</span></span><br><span class="line">          <span class="attr">cors:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="Regarding-runtime"><a href="#Regarding-runtime" class="headerlink" title="Regarding runtime"></a>Regarding runtime</h3><p>The scripts runtine depends on a number of factors, mostly memory size of the Lambda function, number of items in the bucket and type of processing done on these items.</p>
<p>Using the maximum available memory size, a simple analysis of 25.000 items takes ~30s for my use case.</p>
<p>If you find the runtime to be slow, make sure that you are utilizing the proper amount of memory. Make also sure to properly set the <code>Prefix</code> parameter in the S3 config, as this could greatly influence the number of items that have to be checked.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article id="post-pokemunich-analysis" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2016-08-10T16:57:49.000Z"><a href="/2016/08/10/pokemunich-analysis/">10.08.2016</a></time>
      
      
  
    <h1 class="title"><a href="/2016/08/10/pokemunich-analysis/">Distribution of Pokémon in Munich</a></h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <p>After the launch of Pokémon Go at the beginning of July everyone seemed to be on the lookout for Pokémon. While I found the hunt for Pokémon to become tedious after a week or two, I found the idea to have a look at the data behind the game a lot more interesting. To that end, I forked the very popular <a target="_blank" rel="noopener" href="https://github.com/AHAAAAAAA/PokemonGo-Map">Pokémon Go Map</a> project and added some logic to collect and store the data in a MySQL database.</p>
<p>I then used Tableau to build some fancy visualizations of the dataset at hand. All the data I will refer to later can be found <a target="_blank" rel="noopener" href="https://s3.eu-central-1.amazonaws.com/pokemunich/pokemon-munich.zip">here</a></p>
<h3 id="TL-DR-Did-analytics-and-visualizations-on-Pokemon-see-Interactive-Tableau-Sheet"><a href="#TL-DR-Did-analytics-and-visualizations-on-Pokemon-see-Interactive-Tableau-Sheet" class="headerlink" title="TL;DR: Did analytics and visualizations on Pokémon - see Interactive Tableau Sheet"></a><strong>TL;DR: Did analytics and visualizations on Pokémon - see <a target="_blank" rel="noopener" href="https://public.tableau.com/views/MunichsPokemon/distributionpertypeandorder?:embed=y&:display_count=yes&publish=yes">Interactive Tableau Sheet</a></strong></h3><h2 id="The-Data"><a href="#The-Data" class="headerlink" title="The Data"></a>The Data</h2><p>The data collected by the script is pretty raw and simple, with essentially a single table only containing ~206k rows, each one representing the appearance of a single Pokémon. The area I scanned can be best described as a hexagon with a “radius” of around 3.65km (&#x3D;34.6km²) around the center of Munich, Germany. This already gives us some interesting statistics (within certain margin of error of course - see my thoughts regarding the quality of the data below), i.e. a Pokémon appearance rate of 124 Pokémon &#x2F; km² &#x2F; h.</p>
<p><img src="/images/pokemon-table.png" alt="Raw Pokémon data"></p>
<p>This raw data is already interesting on its own, since it contains 3 relevant dimensions: the <code>ID</code> of the Pokémon as well as <code>time</code> and <code>location</code> of its appearance. However, in order to allow for a more extensive and human-friendly representation, we need more data, which I - of course - found in the depth of the internet in the form of an unbelievable number of projects aiming at bringing Pokémon into a structured, queryable format. This allowed me to extract additional data like details, evolution levels or types and store them in my database as well.</p>
<p>Using some simple SQL statements, I created a single SQL table that made a few changes to the original data:</p>
<ul>
<li>Added the type of the Pokémon (id + human-friendly name)</li>
<li>Added the <code>groupId</code> and <code>groupOrder</code> are used to enable clustering on a finer lever by adding Pokémon into logical groups, i.e. Bulbasaur and all its evolutions would be have <code>groupId=1</code> and the respective orders 1,2,3. The screenshot below illustrates this.</li>
</ul>
<img src="/images/groups.png" class="" width="400" title="[groupId and groupOrder]">

<ul>
<li>Added the German and English name of the Pokémon</li>
<li>Replaced the complicated alphanumeric <code>encounter_id</code> with a numeric <code>encounterId</code></li>
<li>Omitted <code>spawnpoint_id</code>, which seemed to be only random, non-repeating IDs</li>
</ul>
<p>We can now use this table and join it with the other tables to create the final result that we’ll use for the visualizations. The following query will give us everything we need - I’m sure it can be further optimized by proper indexes, temporary tables and SQL Voodoo, but since it completes in less than 20 seconds, I didn’t really bother.</p>
<figure class="highlight sql"><figcaption><span>aggregation.sql</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    p.enc_id <span class="keyword">AS</span> encounterId,</span><br><span class="line">    p.pokemon_id <span class="keyword">AS</span> pokemonId,</span><br><span class="line">    pd.name_de <span class="keyword">AS</span> nameDE,</span><br><span class="line">    pd.name_en <span class="keyword">AS</span> nameEN,</span><br><span class="line">    pd.groupId,</span><br><span class="line">    IF(id <span class="operator">&lt;</span> <span class="number">4</span>, id, (pd.id <span class="operator">%</span> pp.groupStartsAt) <span class="operator">+</span> <span class="number">1</span>) <span class="keyword">AS</span> groupOrder,</span><br><span class="line">    pt.type_id <span class="keyword">AS</span> typeId,</span><br><span class="line">    t.type <span class="keyword">AS</span> pokemonType,</span><br><span class="line">    p.latitude <span class="keyword">AS</span> lat,</span><br><span class="line">    p.longitude <span class="keyword">AS</span> lng,</span><br><span class="line">    UNIX_TIMESTAMP(p.disappear_time) <span class="keyword">AS</span> disappearsAt</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span> </span><br><span class="line">        pp.<span class="operator">*</span>, <span class="variable">@rownum</span>:<span class="operator">=</span><span class="variable">@rownum</span> <span class="operator">+</span> <span class="number">1</span> <span class="keyword">AS</span> enc_id</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        pokemon pp, (<span class="keyword">SELECT</span> <span class="variable">@rownum</span>:<span class="operator">=</span><span class="number">0</span>) r</span><br><span class="line">    <span class="keyword">WHERE</span></span><br><span class="line">        pp.disappear_time <span class="operator">&gt;</span> <span class="string">&#x27;2016-07-26 00:00:00&#x27;</span></span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> pp.disappear_time <span class="keyword">ASC</span>) <span class="keyword">AS</span> p</span><br><span class="line">        <span class="keyword">JOIN</span></span><br><span class="line">		(pokemon_types pt, </span><br><span class="line">		pokemon_details pd, </span><br><span class="line">		types t, </span><br><span class="line">		(<span class="keyword">SELECT</span> </span><br><span class="line">			groupId, id <span class="keyword">AS</span> groupStartsAt</span><br><span class="line">		<span class="keyword">FROM</span></span><br><span class="line">			pokemon_details</span><br><span class="line">		<span class="keyword">GROUP</span> <span class="keyword">BY</span> groupId) </span><br><span class="line">        <span class="keyword">AS</span> pp)</span><br><span class="line">    <span class="keyword">ON</span> (p.pokemon_id <span class="operator">=</span> pt.pokemon_id</span><br><span class="line">        <span class="keyword">AND</span> p.pokemon_id <span class="operator">=</span> pd.id</span><br><span class="line">        <span class="keyword">AND</span> t.type_id <span class="operator">=</span> pt.type_id</span><br><span class="line">        <span class="keyword">AND</span> pp.groupId <span class="operator">=</span> pd.groupId)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> encounterId , disappearsAt <span class="keyword">ASC</span></span><br></pre></td></tr></table></figure>

<h3 id="Enhanced-Data"><a href="#Enhanced-Data" class="headerlink" title="Enhanced Data"></a>Enhanced Data</h3><p>Adding the type of a Pokémon increased the number of entries from 205k to 322k since a Pokémon can have multiple types and thus will be listed once for each type, i.e. Pidgey in the screenshot below. We will account for this later in Tableau by making sure we use <code>type</code> as a dimension in our vizs.</p>
<p><img src="/images/pokemon-enhanced-table.png" alt="Enhanced Pokémon data"></p>
<h2 id="Preprocessing"><a href="#Preprocessing" class="headerlink" title="Preprocessing"></a>Preprocessing</h2><p>Tableau proved to be surprisingly clumsy in handling CSV as import data, making it hard for me to bring the data in the desired form. After a few unsatisfying attempts to properly import the CSV with Tableau, I decided to do the preprocessing in Excel and then use this sheet as a data source for the import to Tableau. This went significantly smoother then importing from CSV and gave me nice data to work with. The only things that remained to be adjusted manually where:</p>
<ul>
<li>Transforming the Unix Time of <code>disappear</code> to a proper date using the following formula: <code>DATEADD(&#39;hour&#39;,-8,(Date(&quot;1/1/1970&quot;) + ([disappears]/86400)))</code></li>
<li>Changing the type of ids from continuous to discrete numbers</li>
<li>Tell Tableau that the decimals are actually lat &#x2F; long coordinates</li>
</ul>
<h2 id="Quality-of-the-data"><a href="#Quality-of-the-data" class="headerlink" title="Quality of the data"></a>Quality of the data</h2><p>The available data had a few flaws that we should talk about before continuing.</p>
<h3 id="Missing-Data"><a href="#Missing-Data" class="headerlink" title="Missing Data"></a>Missing Data</h3><p>While collecting the data, I paused the script multiple times for a short while. In this time, no data has been collected at all. This is not a problem if we display the data on a map, but distorts the visualization in time based charts.</p>
<p><img src="/images/missing-data-1.png" alt="Missing data"><br><img src="/images/missing-data-2.png" alt="Distorted visualization"></p>
<h3 id="Changing-search-radius"><a href="#Changing-search-radius" class="headerlink" title="Changing search radius"></a>Changing search radius</h3><p>In addition to stopping the script several times, I also changed the parameters of it multiple times, i.e. increasing&#x2F;decreasing the search radius. This had a direct influence on the number of Pokémon found in a certain interval. As a result of this, absolute numbers are not comparable for different timespans.</p>
<p><img src="/images/pokemon-cardinality.png" alt="Total appearances per hour"></p>
<h3 id="Geographical-distribution"><a href="#Geographical-distribution" class="headerlink" title="Geographical distribution"></a>Geographical distribution</h3><p>Caused by the way the algorithm works (simulating a Pokémon Go player running in an endless spiral from the inside to the outside and then starting over from the center again), the likelihood of missing the appearance of a Pokémon gets higher, the further you move away from the center. We can see this by using the cluster function of Tableau with the number of appearances of a Pokémon as its only parameter. This gives us three clusters (low&#x3D;red, medium&#x3D;yellow, high&#x3D;blue) for the number of total appearances.</p>
<p><img src="/images/pokemon-cluster.png" alt="Cluster"></p>
<p>This clustering is also influenced by the change in search radius, but in my opinion mostly caused by the increased probability of missing a Pokémon in the areas further away from the center.</p>
<h3 id="disappearTime"><a href="#disappearTime" class="headerlink" title="disappearTime"></a><code>disappearTime</code></h3><p>The data we use when aggregating over time is not actually the time when the Pokémon appeared on the map, but rather the date when it will disappear. This is again due to the way the script works, which leads to the fact that we neither know the actual time of appearance nor the Pokémon Go API telling us when a certain Pokémon did actually appear. However, since Niantic tells us the disappear date of each Pokémon, we just assume that each Pokémon stays on the map for the same duration and thus can use the <code>disappear</code> for our timeline, especially when looking for interesting pattern rather than concrete predictions.</p>
<h1 id="Visualization"><a href="#Visualization" class="headerlink" title="Visualization"></a>Visualization</h1><p>The Tableau Sheet I created is <a target="_blank" rel="noopener" href="https://public.tableau.com/views/MunichsPokemon/PokmonStory?:embed=y&:display_count=yes&publish=yes">available here</a> and you can try out everything I’ll describe here - which you should absolutely do.</p>
<h2 id="Count-per-type"><a href="#Count-per-type" class="headerlink" title="Count per type"></a>Count per type</h2><p>This visualization shows all the Pokémon for a certain type (i.e. Bug, Fire, ..) on a map. Pokémon belonging to the same group (i.e. <code>Weedle -&gt; Kakuna -&gt; Beedrill</code>) have the same base color. The size of the marker on the map indicates the number of total appearances for this particular Pokémon. If you analyze the data, different pattern emerge, i.e. for Pokémon of type bug, you can see in the example below, that all three Pokémon of the <code>Weedle -&gt; Kakuna -&gt; Beedrill</code> evolution chain are found in exactly the same places, just with decreasing probability.</p>
<p><img src="/images/pokemon-count-per-type.png" alt="Bug-Pokémon found on map"><br><img src="/images/pokemon-count-per-type-5-weedle.png" alt="Weedle found on map"><br><img src="/images/pokemon-count-per-type-6-kakuna.png" alt="Kakuna found on map"><br><img src="/images/pokemon-count-per-type-7-beedrill.png" alt="Beedrill found on map"></p>
<p>Each pattern is interesting on its own and there’s not enough time to talk about each own here, but one I found particularly interesting is the distribution pattern of the rare Dragon Pokémon, which seems to be aligned with Munich’s heavily frequented Altstadtring and the river Isar.</p>
<p><img src="/images/pokemon-count-per-type-76-dragon.png" alt="Dragons found on map"></p>
<h2 id="Count-per-type-and-evolution"><a href="#Count-per-type-and-evolution" class="headerlink" title="Count per type and evolution"></a>Count per type and evolution</h2><p>This is probably one of the neatest visualizations since it shows a lot of information in a visually very appealing way. It’s basically the same concept like the one we already talked about, but instead of using just one map, we use a grid of maps, where the X-axis is the evolution (aka <code>groupOrder</code>) of the Pokémon and the Y-axis is the type. Again I really encourage you to look at the <a target="_blank" rel="noopener" href="https://public.tableau.com/views/MunichsPokemon/distributionpertypeandorder?:embed=y&:display_count=yes&publish=yes">interactive Tableau Sheet</a> by yourself - you can do it all in your browser and apply your own filters &#x2F; constraints.</p>
<p><img src="/images/pokemon-type-and-evolution.png" alt="Map grid"></p>
<h2 id="Spawns-over-time"><a href="#Spawns-over-time" class="headerlink" title="Spawns over time"></a>Spawns over time</h2><p>That’s a cool one, too. It shows the spawns of all Pokémon on a timeline (in minutes), grouped by Pokémon groups. Each pixel-wide line marks the spawntime (actually <code>disappearsAt</code> - see above) of a Pokémon, color coded by <code>group</code> and <code>pokemonId</code>. You can see that there has been barely a minute, where no Pidgey has spawned somewhere in the area we scanned. You can also see, that spawntimes seem to be distributed fairly even, although the frequency decreases the higher a Pokémon’s evolution level is.</p>
<p><img src="/images/pokemon-spawn-over-time.png" alt="Spawn over time"></p>
<h2 id="Statistical-analysis"><a href="#Statistical-analysis" class="headerlink" title="Statistical analysis"></a>Statistical analysis</h2><p>Another interesting way of looking at the available data is taking coordinates as what they actually are: decimal numbers. This allows as to apply statistical metrics like average or median on them and get valid lat&#x2F;long coordinates as well, which we can than visualize again, i.e. by showing both the average an median spawn points of each Pokémon on our map. The chart shows a higher density of spawn point in the center for the average compared to the median. This reflects what we saw on the previous visualizations as well: More Pokémon spawned in the center than to towards the borders of the scanned area.</p>
<p><img src="/images/pokemon-avg-median-spawn.png" alt="Median and average spawns of Pokémon"></p>
<p>We can also look at metrics like the standard deviation of the spawn points of each Pokémon. This shows how outspread the individual spawn points around the average spawn point of each Pokémon are, meaning that the further a Pokémon is to the right&#x2F;top of the plot, the higher its deviation is. The plot shows the deviation in meters, which at such low distances can be fairly accurately derived from the lat&#x2F;long distances without having to account for the curvature of the earth.</p>
<p>When we look at the median of the standard deviations, we can claim (I know: this is very simplified and not really significant) that the average Pokémon appears 1.8km north&#x2F;south and 1.4km east&#x2F;west from its arithmetical center.</p>
<p>I also tried to find some clusters in the standard deviation plot, but neither <code>type</code> nor <code>group</code> nor <code>groupId</code> resulted in any significant clusters. The clustering in the screenshot below is solely based on the standard deviation of <code>lat</code> and <code>long</code>, which obviously finds (meaningless) clusters.</p>
<p><img src="/images/pokemon-stdev.png" alt="Median and average spawns of Pokémon"></p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>There’s no real conclusion, but we nonetheless found out a few interesting things about where, when and how Pokémon appear in Pokémon Go.</p>
<ul>
<li>Spawn rate and ratio seem to be constant and are not changing over time.</li>
<li>Related Pokémon most of the time spawn in the same areas, although the higher evolved, the less frequent.</li>
<li>Pokémon tend to appear near places that match their type, i.e. Water Pokémon are mostly found near rivers (The same applies for Ice and - weirdly enough - Fire Pokémon).</li>
<li>95.6% of all recorded Pokémon are of the lowest evolution level (1), 4.1% have evolved to the second level and only 0.32% have reached evolution level 3.</li>
<li>There’s a Pidgey and Rattata epidemic in Munich, with each accounting for 14% of all Pokémon.</li>
<li>28 Pokémon never showed up in Munich, 123 out of 151 however did.</li>
<li>There is a relation between evolution level and spawn rate&#x2F;probability (not really surprising), but there is no statistically significant relation between evolution level and spread over the map.</li>
</ul>
<p>I really enjoyed putting this together and hope you found it as fascinating as I did :).</p>
<p><strong>Edit November 2016</strong> Niantic effectively locked-out all crawlers and bots by now, so there will be no fresh data to be collected.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="as_sitesearch" value="www.works-on-my-machine.com">
  </form>
</div>


  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/AWS/">AWS</a><small>1</small></li>
  
    <li><a href="/tags/Azure/">Azure</a><small>1</small></li>
  
    <li><a href="/tags/Blockchain/">Blockchain</a><small>1</small></li>
  
    <li><a href="/tags/CryptoCurrency/">CryptoCurrency</a><small>1</small></li>
  
    <li><a href="/tags/Data/">Data</a><small>1</small></li>
  
    <li><a href="/tags/Lambda/">Lambda</a><small>1</small></li>
  
    <li><a href="/tags/Python/">Python</a><small>1</small></li>
  
    <li><a href="/tags/S3/">S3</a><small>1</small></li>
  
    <li><a href="/tags/Tableau/">Tableau</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2023 Markus Ziller
  
</div>
<div class="clearfix"></div></footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/jquery.imagesloaded.min.js"></script>


<script src="/js/gallery.js"></script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script src="/fancybox/jquery.fancybox.pack.js"></script>

<script>
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
